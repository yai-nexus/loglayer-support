# LogLayer v0.6.0-beta.1 新功能指南

v0.6.0-beta.1 是一个重要的 Beta 版本，引入了三大核心功能增强，显著提升了日志系统的可靠性、性能和开发体验。

## 🎯 核心新功能

### 1. 🛡️ 统一错误处理系统

全新的错误处理系统提供智能错误分类、自动恢复策略和详细的错误统计。

#### 特性亮点

- **智能错误推断**: 自动识别网络、验证、配置等错误类型
- **标准化错误码**: E1000-E6999 系统化错误编码
- **自动恢复策略**: 重试、降级、忽略、停止四种策略
- **错误统计**: 完整的错误跟踪和分析

#### 使用示例

```typescript
import { createBrowserLogger, globalErrorHandler } from 'loglayer'

// 自动错误处理
const logger = await createBrowserLogger({
  errorHandling: {
    captureGlobalErrors: true,
    captureUnhandledRejections: true
  }
})

// 手动错误处理
try {
  await riskyOperation()
} catch (error) {
  // 自动分类和处理
  const handledError = await globalErrorHandler.handle(error, {
    context: 'user-action',
    userId: '12345'
  })
  
  console.log('错误码:', handledError.code)
  console.log('错误类别:', handledError.category)
  console.log('恢复策略:', handledError.recovery)
}

// 获取错误统计
const stats = globalErrorHandler.getStats()
console.log('活跃重试:', stats.activeRetries)
console.log('总重试次数:', stats.totalRetries)
```

#### 错误分类体系

```typescript
enum ErrorCategory {
  CONFIGURATION = 'configuration',  // 配置错误
  NETWORK = 'network',              // 网络错误
  VALIDATION = 'validation',        // 验证错误
  PERMISSION = 'permission',        // 权限错误
  SYSTEM = 'system',               // 系统错误
  UNKNOWN = 'unknown'              // 未知错误
}

enum RecoveryStrategy {
  RETRY = 'retry',        // 重试
  FALLBACK = 'fallback',  // 降级
  IGNORE = 'ignore',      // 忽略
  STOP = 'stop'          // 停止
}
```

### 2. ⚡ 全面性能优化

新的性能优化系统包含智能批处理、快速序列化和内存管理，显著提升日志系统性能。

#### 性能提升数据

- **序列化性能**: 缓存命中率 75%，吞吐量 148 ops/sec
- **批处理效率**: 自适应批处理，减少 60% 网络请求
- **内存优化**: 智能压缩，减少 30-50% 内存使用

#### 智能批处理

```typescript
const logger = await createBrowserLogger({
  outputs: {
    http: {
      enabled: true,
      endpoint: '/api/logs',
      batchSize: 50,              // 批次大小
      flushInterval: 10000,       // 刷新间隔
      adaptive: true              // 自适应批处理
    }
  }
})

// 获取批处理统计
const batcher = logger.getBatcher()
const stats = batcher.getStats()
console.log('批处理效率:', stats.efficiency)
console.log('平均批次大小:', stats.averageBatchSize)
```

#### 快速序列化

```typescript
import { FastSerializer } from 'loglayer/core'

const serializer = new FastSerializer({
  fastMode: true,     // 快速模式
  caching: true,      // 启用缓存
  cacheSize: 100      // 缓存大小
})

// 序列化数据
const result = serializer.serialize(data, 'cache-key')

// 获取序列化统计
const stats = serializer.getStats()
console.log('缓存命中率:', stats.cacheHitRate)
console.log('平均序列化时间:', stats.averageSerializationTime)
```

#### 内存管理

```typescript
import { MemoryManager } from 'loglayer/core'

const memoryManager = new MemoryManager({
  maxMemoryUsage: 50,    // 最大内存使用 (MB)
  checkInterval: 5000,   // 检查间隔
  compression: true      // 启用压缩
})

// 压缩数据
const compressed = memoryManager.compress(largeData)

// 获取内存统计
const stats = memoryManager.getStats()
console.log('当前内存使用:', stats.currentUsage)
console.log('压缩率:', stats.compressionRatio)
```

### 3. ✅ 全面配置验证

新的配置验证系统提供详细的错误提示、智能建议和分级验证结果。

#### 验证特性

- **类型验证**: 确保配置字段类型正确
- **值范围验证**: 检查数值、字符串长度等
- **枚举验证**: 验证日志级别等枚举值
- **依赖关系验证**: 检查配置间的逻辑关系
- **智能建议**: 拼写错误纠正、最佳实践提示

#### 使用示例

```typescript
import { validateBrowserConfig, validateBrowserConfigStrict } from 'loglayer'

// 基础验证
const config = {
  level: 'info',
  outputs: {
    console: true,
    http: { endpoint: '/api/logs' }
  }
}

const result = validateBrowserConfig(config)
if (!result.valid) {
  console.error('配置错误:', result.errors)
  console.warn('配置警告:', result.warnings)
  console.info('配置建议:', result.suggestions)
}

// 严格验证（抛出错误）
try {
  validateBrowserConfigStrict(config)
  console.log('配置验证通过')
} catch (error) {
  console.error('配置验证失败:', error.message)
}
```

#### 验证结果示例

```typescript
// 验证结果结构
interface ValidationResult {
  valid: boolean
  errors: Array<{
    code: string
    message: string
    path: string
    value: any
    severity: 'low' | 'medium' | 'high' | 'critical'
    expected?: string
  }>
  warnings: Array<{
    message: string
    path: string
    value: any
  }>
  suggestions: Array<{
    message: string
    path: string
    suggestedConfig: any
  }>
}
```

## 🔧 迁移指南

### 从 v0.5.x 迁移

#### 1. 更新依赖

```bash
npm install loglayer@0.6.0-beta.1
```

#### 2. 配置更新

```typescript
// v0.5.x
const logger = createLogger({
  outputs: ['console', 'http']
})

// v0.6.0-beta.1
const logger = await createBrowserLogger({
  outputs: {
    console: { enabled: true },
    http: { 
      enabled: true,
      endpoint: '/api/logs'
    }
  }
})
```

#### 3. 错误处理更新

```typescript
// v0.5.x
logger.error('Error occurred', error)

// v0.6.0-beta.1 (推荐)
logger.logError(error, { context: 'user-action' })
```

### 破坏性变更

1. **配置结构变更**: 输出器配置从数组改为对象
2. **异步创建**: `createBrowserLogger` 现在是异步函数
3. **错误处理**: 新增专用的 `logError` 方法

### 兼容性

- **Node.js**: >= 16.0.0
- **浏览器**: 现代浏览器 (ES2020+)
- **TypeScript**: >= 4.5.0

## 🎯 最佳实践

### 1. 性能优化配置

```typescript
const logger = await createBrowserLogger({
  // 生产环境配置
  level: 'warn',
  sampling: { rate: 0.1 },
  outputs: {
    http: {
      enabled: true,
      endpoint: '/api/logs',
      batchSize: 100,
      flushInterval: 30000,
      retryAttempts: 3
    }
  }
})
```

### 2. 开发环境配置

```typescript
const logger = await createBrowserLogger({
  // 开发环境配置
  level: 'debug',
  outputs: {
    console: {
      enabled: true,
      colorized: true,
      showMetadataTable: true
    }
  },
  errorHandling: {
    captureGlobalErrors: true
  }
})
```

### 3. 错误处理策略

```typescript
const logger = await createBrowserLogger({
  errorHandling: {
    captureGlobalErrors: true,
    captureUnhandledRejections: true,
    errorFilter: (error) => {
      // 过滤第三方错误
      return !error.stack?.includes('third-party-lib')
    }
  },
  outputs: {
    http: {
      enabled: true,
      endpoint: '/api/logs',
      onError: (error, data) => {
        // 降级到本地存储
        localStorage.setItem('failed-logs', JSON.stringify(data))
      }
    }
  }
})
```

## 📊 性能基准

### 测试环境

- **CPU**: Intel i7-10700K
- **内存**: 32GB DDR4
- **浏览器**: Chrome 120+

### 基准结果

| 功能 | v0.5.x | v0.6.0-beta.1 | 提升 |
|------|--------|---------------|------|
| 序列化速度 | 85 ops/sec | 148 ops/sec | +74% |
| 批处理效率 | 60% | 85% | +42% |
| 内存使用 | 100% | 65% | -35% |
| 错误处理延迟 | 15ms | 8ms | -47% |

## 🔮 未来计划

### v0.6.0 正式版

- 性能进一步优化
- 更多输出器支持
- 增强的错误分析

### v0.7.0

- 实时日志流
- 高级过滤器
- 插件系统

## 🐛 已知问题

1. **IndexedDB 初始化**: 在某些浏览器中可能较慢
2. **大数据序列化**: 超大对象可能影响性能
3. **内存监控**: 在 Web Worker 中功能受限

## 📞 支持

- **GitHub Issues**: [报告问题](https://github.com/loglayer/loglayer/issues)
- **文档**: [完整文档](https://loglayer.dev)
- **社区**: [Discord 频道](https://discord.gg/loglayer)

---

**注意**: v0.6.0-beta.1 是 Beta 版本，建议在非生产环境中测试后再部署到生产环境。
